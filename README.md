# NetBox Zabbix Plugin

## Overview

The **NetBox Zabbix Plugin** integrates Zabbix with NetBox so that 
you can manage your monitoring infrastructure directly from NetBox.

With this plugin, you can:

* Administrate Zabbix hosts from NetBox.
* Configure host interfaces (restricted to Agent and SNMPv3 only).
* Import existing hosts from Zabbix to keep your NetBox inventory up to date.
* Create and manage Zabbix Proxies, Proxy Groups and Host Groups without leaving NetBox.
* Organize hosts into Zabbix Host Groups directly from your NetBox environment.
* Define Device and VM Mappings to automatically generate initial Zabbix configurations based on NetBox metadata, such as Site, Platform, and Role, for new Zabbix hosts.


---

## Installation

1. **Install the plugin into your NetBox environment**:

Install the plugin directly from GitHub and ensure the required Zabbix API library is installed:

```bash
pip install git+https://github.com/pergus/netbox-zabbix.git'
pip install pyzabbix==1.3.1
```
Note: This must be done inside the same virtual environment where NetBox is installed.

2. **Add the plugin to NetBox configuration** (`configuration.py`):

Open your NetBox configuration file (usually netbox/netbox/configuration.py) and add:

```python
PLUGINS = [
    'netbox_zabbix',
]
```
If you already have other plugins listed, simply append 'netbox_zabbix'.


3. **Apply database migrations**:

Generate and apply the database migrations for the plugin:

```bash
manage.py makemigrations netbox_zabbix
manage.py migrate netbox_zabbix
```

4. **Run the setup zabbix management command**:
The setup zabbix managemetn command initializes required defaults, mappings, and cryptographic keys.

```bash
manage.py setup_zabbix
```

This interactive command walks the user through two required setup phases, 
followed by a required configuration change in configuration.py.



5. **Copy the PLUGINS_CONFIG to NetBox configuration** (`configuration.py`):
Copy the configuration block printed after the setup command and add it to your NetBox configuration.py.

```bash
PLUGINS_CONFIG = {
    'netbox_zabbix': {
        "FERNET_KEY_PATH": "/opt/netbox/netbox-zabbix/netbox_zabbix/fernet.key"
    }
}  
```

The FERNET_KEY_PATH must point to the fernet.key file generated by the setup script.
Ensure this path is readable only by the NetBox service user.


6. **Restart NetBox**:
After modifying the configuration or installing plugins, restart all NetBox services:

```bash
sudo systemctl restart netbox netbox-rq
```

---


## The Setup Zabbix Management Command

The setup zabbix management command initializes required defaults, mappings, and cryptographic keys.
Below are a description of each individual step in the setup process.
The setup script is divided into two parts. The first part prompts the user to configure the connection to Zabbix and stores this information securely in the NetBox database. The second part allows the user to configure default Device and VM mappings.

To start the command run:

```bash
manage.py setup_zabbix
```



**Part 1 — Configure Zabbix Connection**

Step 1. Enter a name for this configuration

```bash
Enter the name of the setting instance [config]:
```
This becomes the instance name of the Setting object.


Step 2. Enter the Zabbix host and URLs
The script auto-detects the machine hostname and proposes defaults:

```bash
Enter the Zabbix host [myserver.example.com]:
Enter the Zabbix API URL [https://myserver.example.com/api_jsonrpc.php]:
Enter the Zabbix Web URL [https://myserver.example.com]:
```
The user can accept defaults or enter custom values.

Step 3. Enter the Zabbix API Token
The token cannot be empty. The command will repeat the prompt until a non-empty value is provided:

```bash
Enter the Zabbix API token:
```

Step 4. Provide or confirm the path to the fernet.key file
The plugin uses Fernet encryption for secure token storage.

```bash
Path to Fernet key file [/opt/netbox/netbox_zabbix/fernet.key]:
```

The user may:
Accept the default path, or
Provide a custom path.

If the file does not exist, the script creates the file and the fernet key automatically and prints the location.

Step 5. The script imports data from Zabbix

The plugin now contacts Zabbix and loads:

* Templates
* Host groups
* Proxies
* Proxy groups



**Part 2 — Configure Device and VM Mappings**

The script next asks the user to define default mappings for devices and virtual machines.
These values will be used when automatically assigning Zabbix templates and groups to NetBox objects.

Step 7. Select the default Template (required)

```bash
Enter Default Template
 1. ICMP Ping
 2. Linux by Zabbix agent
 3. SNMP Device
Select a number [1–3]:
```

Step 8. Select the default Host Group (required)
Similar numbered list:

```bash
Enter Default Host Group
 1. Linux Servers
 2. Network Devices
Select a number [1–2]:
```

Step 9. Select the Default Proxy (optional — may skip with Enter)

```bash
Enter Default Proxy
 1. zbx-proxy-eu
 2. zbx-proxy-us
Select a number [1–2] (Enter to skip):
```

Step 10. Select the Default Proxy Group (optional — may skip with Enter)

```bash
Enter Default Proxy Group
 1. EU Datacenter
 2. US Datacenter
Select a number [1–2] (Enter to skip):
```

Step 11. The script stores the mappings in the database
Both DeviceMapping and VMMapping are created or updated.

Step 12. Final Step — Add FERNET_KEY_PATH to NetBox configuration
At the end of the setup, the script prints instructions:

```bash
Next Required Step

You must add the path to your fernet.key file in PLUGINS_CONFIG:

PLUGINS_CONFIG = {
    'netbox_zabbix': {
        "FERNET_KEY_PATH": "/opt/netbox/netbox_zabbix/fernet.key"
    }
}
```

---

## Contributing

We welcome contributions! Please fork the repository and submit pull requests with enhancements, bug fixes, or new features.

---

## License

Distributed under the MIT License. See `LICENSE` for more information.
